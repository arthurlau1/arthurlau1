<#
.SYNOPSIS
    Storage of administrative credentials could allow unauthorized access. Disallowing the storage of RunAs credentials for Windows Remote Management will prevent them from being used with plug-ins.
    Author          : Arthur Lau
    LinkedIn        : linkedin.com/in/arthur-lau-4a7403172/
    GitHub          : github.com/arthurlau1
    Date Created    : 2025-09-011
    Last Modified   : 2025-09-011
    Date Created    : 2024-09-09
    Last Modified   : 2024-09-09
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN10-AU-000082

.TESTED ON
    Date(s) Tested  : 
    Tested By       : 
    Systems Tested  : 
    PowerShell Ver. : 

.USAGE
    Put any usage instructions here.
    Example syntax:
     
#>

# YOUR CODE GOES HERE
# STIG ID: WN10-AU-000082
# Purpose: Ensure "File Share - Success" auditing is enabled for Object Access events

$subcategory = "File Share"
$desiredSetting = "Success"

Write-Output "Checking compliance for STIG ID: WN10-AU-000082 ..."
Write-Output "Ensuring 'Audit: Force audit policy subcategory settings' (WN10-SO-000030) is enabled..."

# --- 1. Ensure subcategory auditing is enforced (WN10-SO-000030 dependency) ---
$lsaPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
$lsaName = "SCENoApplyLegacyAuditPolicy"
$lsaValue = (Get-ItemProperty -Path $lsaPath -Name $lsaName -ErrorAction SilentlyContinue).$lsaName

if ($lsaValue -ne 1) {
    Write-Output "Non-Compliant: Advanced audit policy enforcement is not enabled. Enabling now..."
    Set-ItemProperty -Path $lsaPath -Name $lsaName -Value 1 -Type DWord
    Write-Output "Remediated: Enabled advanced audit policy enforcement (SCENoApplyLegacyAuditPolicy = 1)."
} else {
    Write-Output "Compliant: Advanced audit policy enforcement is already enabled."
}

# --- 2. Check current audit policy for 'File Share' subcategory ---
$currentSetting = (auditpol /get /subcategory:"$subcategory" 2>$null | Select-String "Success").ToString()

if ($currentSetting -match "Success") {
    Write-Output "Compliant: '$subcategory' is already auditing Success events."
}
else {
    Write-Output "Non-Compliant: '$subcategory' is not auditing Success events. Applying remediation..."
    auditpol /set /subcategory:"$subcategory" /success:enable | Out-Null
    Write-Output "Remediated: Enabled Success auditing for '$subcategory'."
}

# --- 3. Verify configuration after remediation ---
$verifySetting = (auditpol /get /subcategory:"$subcategory" 2>$null | Select-String "Success").ToString()
if ($verifySetting -match "Success") {
    Write-Output "Verification passed: '$subcategory' is now auditing Success events."
} else {
    Write-Output "Verification failed: please manually check with 'auditpol /get /subcategory:\"$subcategory\"'."
}

Write-Output "Compliance verification complete for STIG ID: WN10-AU-000082."

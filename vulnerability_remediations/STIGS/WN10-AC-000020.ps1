<#
.SYNOPSIS
    A system is more vulnerable to unauthorized access when system users recycle the same password several times without being required to change a password to a unique password on a regularly scheduled basis. 
    This enables users to effectively negate the purpose of mandating periodic password changes. The default value is 24 for Windows domain systems. DoD has decided this is the appropriate value for all Windows systems.

.NOTES
    Author          : Arthur Lau
    LinkedIn        : linkedin.com/in/arthur-lau-4a7403172/
    GitHub          : github.com/arthurlau1
    Date Created    : 2025-09-011
    Last Modified   : 2025-09-011
    Date Created    : 2024-09-09
    Last Modified   : 2024-09-09
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN10-AC-000020

.TESTED ON
    Date(s) Tested  : 
    Tested By       : 
    Systems Tested  : 
    PowerShell Ver. : 

.USAGE
    Put any usage instructions here.
    Example syntax:
     
#>

# YOUR CODE GOES HERE
# STIG ID: WN10-AC-000020
# Purpose: Ensure "Enforce password history" is configured to remember at least 24 passwords

$desiredValue = 24
$tempFile = "$env:TEMP\secpol.cfg"

Write-Output "Checking compliance for STIG ID: WN10-AC-000020 (Enforce password history)..."

# --- 1. Export current local security policy ---
secedit /export /cfg $tempFile /quiet

# --- 2. Read the Enforce Password History line ---
$currentLine = (Select-String -Path $tempFile -Pattern "PasswordHistorySize").ToString()

if ($null -eq $currentLine) {
    Write-Output "No existing password history policy found â€” will create one."
    $currentValue = 0
} else {
    $currentValue = [int]($currentLine.Split("=")[1].Trim())
}

# --- 3. Check compliance ---
if ($currentValue -ge $desiredValue) {
    Write-Output "Compliant: Enforce password history is set to $currentValue (>= $desiredValue)"
}
else {
    Write-Output "Non-Compliant: Enforce password history is set to $currentValue (< $desiredValue)"
    Write-Output "Remediating to $desiredValue..."

    # --- 4. Update configuration file ---
    (Get-Content $tempFile) | ForEach-Object {
        if ($_ -match "PasswordHistorySize") {
            "PasswordHistorySize = $desiredValue"
        } else {
            $_
        }
    } | Set-Content $tempFile

    # If no line existed, append it
    if ($null -eq $currentLine) {
        Add-Content $tempFile "PasswordHistorySize = $desiredValue"
    }

    # --- 5. Apply updated policy ---
    secedit /configure /db "$env:windir\security\local.sdb" /cfg $tempFile /areas SECURITYPOLICY /quiet
    gpupdate /force | Out-Null

    Write-Output "Remediated: Enforce password history updated to $desiredValue passwords remembered."
}

# --- 6. Cleanup temporary file ---
Remove-Item $tempFile -ErrorAction SilentlyContinue

Write-Output "Verification complete for STIG ID: WN10-AC-000020."

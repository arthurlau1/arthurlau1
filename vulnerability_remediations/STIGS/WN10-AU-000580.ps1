<#
.SYNOPSIS
    Maintaining an audit trail of system activity logs can help identify configuration errors, troubleshoot service disruptions, and analyze compromises that have occurred, as well as detect attacks. 
    Audit logs are necessary to provide a trail of evidence in case the system or network is compromised. Collecting this data is essential for analyzing the security of information assets and detecting signs of suspicious and unexpected behavior.
    Audit MPSSVC Rule-Level Policy Change determines whether the operating system generates audit events when changes are made to policy rules for the Microsoft Protection Service (MPSSVC.exe).

.NOTES
    Author          : Arthur Lau
    LinkedIn        : linkedin.com/in/arthur-lau-4a7403172/
    GitHub          : github.com/arthurlau1
    Date Created    : 2025-09-011
    Last Modified   : 2025-09-011
    Date Created    : 2024-09-09
    Last Modified   : 2024-09-09
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN10-AU-000580

.TESTED ON
    Date(s) Tested  : 
    Tested By       : 
    Systems Tested  : 
    PowerShell Ver. : 

.USAGE
    Put any usage instructions here.
    Example syntax:
     
#>

# YOUR CODE GOES HERE
# STIG ID: WN10-AU-000580
# Purpose: Ensure "MPSSVC Rule-Level Policy Change" auditing is configured for Failure events

$subcategory = "MPSSVC Rule-Level Policy Change"
$desiredSetting = "Failure"

Write-Output "Checking Audit Policy for '$subcategory' ..."

# --- 1. Verify that advanced audit policy enforcement is enabled (WN10-SO-000030 dependency) ---
$advancedAudit = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "SCENoApplyLegacyAuditPolicy" -ErrorAction SilentlyContinue).SCENoApplyLegacyAuditPolicy

if ($advancedAudit -ne 1) {
    Write-Output "Non-Compliant: Advanced audit policy enforcement is not enabled. Enabling it now..."
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "SCENoApplyLegacyAuditPolicy" -Value 1 -Type DWord
    Write-Output "Remediated: Enabled advanced audit policy enforcement (WN10-SO-000030)."
}

# --- 2. Get current audit setting for the subcategory ---
$currentSetting = (auditpol /get /subcategory:"$subcategory" 2>$null | Select-String "Failure").ToString()

if ($currentSetting -match "Failure") {
    Write-Output "Compliant: '$subcategory' is already auditing Failure events."
}
else {
    Write-Output "Non-Compliant: '$subcategory' is not auditing Failure events. Applying fix..."
    auditpol /set /subcategory:"$subcategory" /failure:enable | Out-Null
    Write-Output "Remediated: Enabled Failure auditing for '$subcategory'."
}

# --- 3. Verify remediation ---
$verifySetting = (auditpol /get /subcategory:"$subcategory" 2>$null | Select-String "Failure").ToString()
if ($verifySetting -match "Failure") {
    Write-Output "Verification passed: '$subcategory' is auditing Failure events."
} else {
    Write-Output "Verification failed: please recheck manually with 'auditpol /get /subcategory:\"$subcategory\"'."
}

Write-Output "Compliance check complete for STIG ID: WN10-AU-000580."
